<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥³å·«çš„æ¯’è¯å•è¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* ç¡®ä¿ body å’Œ html å æ®æ•´ä¸ªè§†å£ï¼Œå¹¶ä¸”ç»å¯¹ä¸æ»šåŠ¨ */
        html, body {
            height: 100%;
            overflow: hidden; /* å…³é”®ï¼šç¦ç”¨ä¸»é¡µé¢æ»šåŠ¨ */
        }

        /* å•è¯å¡ç½‘æ ¼ï¼šé€‚åº”å®¹å™¨å¤§å°ï¼Œä¿æŒç´§å‡‘ï¼Œå¹¶åˆ©ç”¨æ‰€æœ‰å‚ç›´ç©ºé—´ */
        .potion-grid {
            display: grid;
            /* é»˜è®¤å¸ƒå±€ï¼šå°½å¯èƒ½å¤šåœ°æ”¾ç½®å¡ç‰‡ï¼Œå¹¶è‡ªåŠ¨åˆ›å»ºè¡Œ */
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            grid-auto-rows: 1fr; /* ç¡®ä¿è¡Œé«˜å¹³å‡åˆ†é… */
            gap: 0.5rem; /* é—´éš™æ›´å° */
            height: 100%; /* å æ®æ‰€æœ‰çˆ¶å®¹å™¨é«˜åº¦ */
            overflow: hidden; /* ç¡®ä¿ä¸ç”Ÿæˆæ»šåŠ¨æ¡ */
        }

        /* åª’ä½“æŸ¥è¯¢ï¼šåœ¨å¤§å±å¹•ä¸Šå¼ºåˆ¶ 6 åˆ— x 3 è¡Œå¸ƒå±€ä»¥å®Œç¾å®¹çº³ 18 å¼ å¡ */
        @media (min-width: 1024px) { /* lg: breakpoint */
            .potion-grid {
                grid-template-columns: repeat(6, 1fr); /* 6 åˆ— */
                grid-template-rows: repeat(3, 1fr);  /* 3 è¡Œ */
            }
        }
        
        /* *** è‡ªå®šä¹‰ h-70 (280px) *** */
        .h-70 {
            height: 17.5rem; /* 280px */
        }

        .word-card {
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.25rem; /* æåº¦å‹ç¼©å¡«å…… */
            text-align: center;
            height: 100%; /* å¡«æ»¡ç½‘æ ¼å•å…ƒ */
        }
        .text-black-on-white {
             color: #1f2937;
        }
        
        /* å…è®¸æ—¥å¿—å’Œç©å®¶åˆ—è¡¨å†…éƒ¨æ»šåŠ¨ï¼Œä»¥ä¿æŒå¤–éƒ¨å¸ƒå±€ç´§å‡‘ */
        .internal-scroll {
            overflow-y: auto;
        }

        /* è°ƒæ•´é¡¶éƒ¨é¢æ¿çš„padding */
        .top-panel-p {
            padding: 0.75rem; /* p-3 */
        }

        /* ä»…ç”¨äºæ¨¡æ‹Ÿå†…å®¹è¿‡å¤šï¼Œå¯åˆ é™¤æˆ–ä¿æŒ */
        .dummy-content {
            height: 800px; /* æ•…æ„è®©å†…å®¹å¤§äºå®¹å™¨çš„å›ºå®šé«˜åº¦ */
            background-color: #3f3f46; /* è¾ƒæš—çš„èƒŒæ™¯è‰² */
            line-height: 20px;
            color: #d1d5db;
            padding: 5px;
        }
    </style>
</head>
<body class="h-screen bg-gray-900 text-white p-2 sm:p-4 flex flex-col">

    <header class="text-center mb-2 sm:mb-3 flex-shrink-0">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-400 tracking-wider">
            <span class="inline-block transform -rotate-6">ğŸ“š</span> å¥³å·«çš„æ¯’è¯å•è¯ç‰ˆ
        </h1>
    </header>

    <main id="game-container" class="max-w-7xl mx-auto w-full flex-grow min-h-0 flex flex-col space-y-2 sm:space-y-3">
        
        <div class="flex-shrink-0 grid grid-cols-1 lg:grid-cols-3 gap-2 sm:gap-3 h-70 overflow-hidden">
            
            <div id="status-panel-container" class="h-full overflow-y-auto">
                <h3>âœ… çŠ¶æ€å’Œæ§åˆ¶é¢æ¿</h3>
                <div class="dummy-content">
                    å†…å®¹æ»šåŠ¨åŒºåŸŸ 1... (æ­¤å¤„å†…å®¹æ•…æ„å¾ˆå¤šï¼Œä»¥è§¦å‘æ»šåŠ¨æ¡)
                </div>
            </div>

            <div id="player-status-container" class="h-full overflow-y-auto">
                <h3>ğŸ‘¤ ç©å®¶çŠ¶æ€</h3>
                <div class="dummy-content">
                    å†…å®¹æ»šåŠ¨åŒºåŸŸ 2... (æ­¤å¤„å†…å®¹æ•…æ„å¾ˆå¤šï¼Œä»¥è§¦å‘æ»šåŠ¨æ¡)
                </div>
            </div>
            
            <div id="game-log-container" class="h-full overflow-y-auto">
                <h3>ğŸ“œ æ¸¸æˆæ—¥å¿—</h3>
                <div class="dummy-content">
                    å†…å®¹æ»šåŠ¨åŒºåŸŸ 3... (æ­¤å¤„å†…å®¹æ•…æ„å¾ˆå¤šï¼Œä»¥è§¦å‘æ»šåŠ¨æ¡)
                </div>
            </div>
        </div>

        <div id="potion-selection-area" class="bg-gray-800 p-3 rounded-3xl shadow-3xl border-4 border-dashed border-indigo-600 flex-grow min-h-0 hidden flex-col">
            <h2 class="text-xl sm:text-2xl font-bold text-white mb-1 text-center flex-shrink-0">
                <span id="current-theme-name">å•è¯</span>æ±  (å…± 18 å¼ )
            </h2>
            <div id="potions-grid" class="potion-grid">
                </div>
        </div>
    </main>
    
    <div id="confirmation-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div id="modal-content" class="bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700">
            </div>
    </div>


    <script>
        // --- è¯åº“é…ç½® (Themes) ---
        const ALL_THEMES = {
            colors: {
                name: "é¢œè‰² (Colors)",
                items: [
                    { en: 'Red', cn: 'çº¢è‰²', hex: '#ef4444', id: 'c1' },
                    { en: 'Blue', cn: 'è“è‰²', hex: '#3b82f6', id: 'c2' },
                    { en: 'Green', cn: 'ç»¿è‰²', hex: '#22c55e', id: 'c3' },
                    { en: 'Yellow', cn: 'é»„è‰²', hex: '#eab308', id: 'c4' },
                    { en: 'Purple', cn: 'ç´«è‰²', hex: '#9333ea', id: 'c5' },
                    { en: 'Orange', cn: 'æ©™è‰²', hex: '#f97316', id: 'c6' },
                    { en: 'Pink', cn: 'ç²‰è‰²', hex: '#db2777', id: 'c7' },
                    { en: 'Black', cn: 'é»‘è‰²', hex: '#1f2937', id: 'c8' },
                    { en: 'White', cn: 'ç™½è‰²', hex: '#f3f4f6', txt: '#000', id: 'c9' },
                    { en: 'Gray', cn: 'ç°è‰²', hex: '#6b7280', id: 'c10' },
                    { en: 'Brown', cn: 'æ£•è‰²', hex: '#78350f', id: 'c11' },
                    { en: 'Cyan', cn: 'é’è‰²', hex: '#06b6d4', id: 'c12' },
                    { en: 'Gold', cn: 'é‡‘è‰²', hex: '#fbbf24', id: 'c13' },
                    { en: 'Silver', cn: 'é“¶è‰²', hex: '#9ca3af', id: 'c14' },
                    { en: 'Lime', cn: 'é…¸æ©™ç»¿', hex: '#84cc16', id: 'c15' },
                    { en: 'Violet', cn: 'ç´«ç½—å…°', hex: '#7c3aed', id: 'c16' },
                    { en: 'Indigo', cn: 'é›é’', hex: '#4338ca', id: 'c17' },
                    { en: 'Teal', cn: 'è“ç»¿', hex: '#14b8a6', id: 'c18' },
                    { en: 'Maroon', cn: 'è¤çº¢è‰²', hex: '#800000', id: 'c19' },
                    { en: 'Navy', cn: 'æµ·å†›è“', hex: '#000080', id: 'c20' }
                ]
            },
            animals: {
                name: "åŠ¨ç‰© (Animals)",
                items: [
                    { en: 'Lion', cn: 'ç‹®å­', emoji: 'ğŸ¦', id: 'a1' },
                    { en: 'Tiger', cn: 'è€è™', emoji: 'ğŸ¯', id: 'a2' },
                    { en: 'Elephant', cn: 'å¤§è±¡', emoji: 'ğŸ˜', id: 'a3' },
                    { en: 'Monkey', cn: 'çŒ´å­', emoji: 'ğŸ’', id: 'a4' },
                    { en: 'Dog', cn: 'ç‹—', emoji: 'ğŸ¶', id: 'a5' },
                    { en: 'Cat', cn: 'çŒ«', emoji: 'ğŸ±', id: 'a6' },
                    { en: 'Rabbit', cn: 'å…”å­', emoji: 'ğŸ°', id: 'a7' },
                    { en: 'Bear', cn: 'ç†Š', emoji: 'ğŸ»', id: 'a8' },
                    { en: 'Panda', cn: 'ç†ŠçŒ«', emoji: 'ğŸ¼', id: 'a9' },
                    { en: 'Fox', cn: 'ç‹ç‹¸', emoji: 'ğŸ¦Š', id: 'a10' },
                    { en: 'Pig', cn: 'çŒª', emoji: 'ğŸ·', id: 'a11' },
                    { en: 'Cow', cn: 'ç‰›', emoji: 'ğŸ®', id: 'a12' },
                    { en: 'Sheep', cn: 'ç¾Š', emoji: 'ğŸ‘', id: 'a13' },
                    { en: 'Horse', cn: 'é©¬', emoji: 'ğŸ´', id: 'a14' },
                    { en: 'Zebra', cn: 'æ–‘é©¬', emoji: 'ğŸ¦“', id: 'a15' },
                    { en: 'Giraffe', cn: 'é•¿é¢ˆé¹¿', emoji: 'ğŸ¦’', id: 'a16' },
                    { en: 'Snake', cn: 'è›‡', emoji: 'ğŸ', id: 'a17' },
                    { en: 'Bird', cn: 'é¸Ÿ', emoji: 'ğŸ¦', id: 'a18' },
                    { en: 'Fish', cn: 'é±¼', emoji: 'ğŸŸ', id: 'a19' },
                    { en: 'Shark', cn: 'é²¨é±¼', emoji: 'ğŸ¦ˆ', id: 'a20' },
                    { en: 'Frog', cn: 'é’è›™', emoji: 'ğŸ¸', id: 'a21' },
                    { en: 'Whale', cn: 'é²¸é±¼', emoji: 'ğŸ³', id: 'a22' },
                ]
            },
            fruits: {
                name: "æ°´æœ (Fruits)",
                items: [
                    { en: 'Apple', cn: 'è‹¹æœ', emoji: 'ğŸ', id: 'f1' },
                    { en: 'Banana', cn: 'é¦™è•‰', emoji: 'ğŸŒ', id: 'f2' },
                    { en: 'Grape', cn: 'è‘¡è„', emoji: 'ğŸ‡', id: 'f3' },
                    { en: 'Orange', cn: 'æ©™å­', emoji: 'ğŸŠ', id: 'f4' },
                    { en: 'Lemon', cn: 'æŸ æª¬', emoji: 'ğŸ‹', id: 'f5' },
                    { en: 'Watermelon', cn: 'è¥¿ç“œ', emoji: 'ğŸ‰', id: 'f6' },
                    { en: 'Strawberry', cn: 'è‰è“', emoji: 'ğŸ“', id: 'f7' },
                    { en: 'Peach', cn: 'æ¡ƒå­', emoji: 'ğŸ‘', id: 'f8' },
                    { en: 'Cherry', cn: 'æ¨±æ¡ƒ', emoji: 'ğŸ’', id: 'f9' },
                    { en: 'Pear', cn: 'æ¢¨', emoji: 'ğŸ', id: 'f10' },
                    { en: 'Pineapple', cn: 'è è', emoji: 'ğŸ', id: 'f11' },
                    { en: 'Coconut', cn: 'æ¤°å­', emoji: 'ğŸ¥¥', id: 'f12' },
                    { en: 'Mango', cn: 'èŠ’æœ', emoji: 'ğŸ¥­', id: 'f13' },
                    { en: 'Kiwi', cn: 'çŒ•çŒ´æ¡ƒ', emoji: 'ğŸ¥', id: 'f14' },
                    { en: 'Avocado', cn: 'ç‰›æ²¹æœ', emoji: 'ğŸ¥‘', id: 'f15' },
                    { en: 'Melon', cn: 'ç”œç“œ', emoji: 'ğŸˆ', id: 'f16' },
                    { en: 'Tomato', cn: 'è¥¿çº¢æŸ¿', emoji: 'ğŸ…', id: 'f17' },
                    { en: 'Blueberry', cn: 'è“è“', emoji: 'ğŸ«', id: 'f18' },
                    { en: 'Raspberry', cn: 'æ ‘è“', emoji: 'ğŸ‡', id: 'f19' },
                    { en: 'Lime', cn: 'é’æŸ ', emoji: 'ğŸŸ¢', id: 'f20' },
                    { en: 'Fig', cn: 'æ— èŠ±æœ', emoji: 'ğŸŸ£', id: 'f21' },
                    { en: 'Plum', cn: 'æå­', emoji: 'ğŸ«', id: 'f22' }
                ]
            },
            school: {
                name: "å­¦ä¹ ç”¨å…· (School Supplies)",
                items: [
                    { en: 'Pen', cn: 'é’¢ç¬”', emoji: 'ğŸ–Šï¸', id: 's1' },
                    { en: 'Pencil', cn: 'é“…ç¬”', emoji: 'âœï¸', id: 's2' },
                    { en: 'Eraser', cn: 'æ©¡çš®', emoji: 'â¬œ', id: 's3' },
                    { en: 'Notebook', cn: 'ç¬”è®°æœ¬', emoji: 'ğŸ““', id: 's4' },
                    { en: 'Book', cn: 'ä¹¦', emoji: 'ğŸ“–', id: 's5' },
                    { en: 'Ruler', cn: 'å°ºå­', emoji: 'ğŸ“', id: 's6' },
                    { en: 'Backpack', cn: 'èƒŒåŒ…', emoji: 'ğŸ’', id: 's7' },
                    { en: 'Scissors', cn: 'å‰ªåˆ€', emoji: 'âœ‚ï¸', id: 's8' },
                    { en: 'Glue', cn: 'èƒ¶æ°´', emoji: 'ğŸ’§', id: 's9' },
                    { en: 'Globe', cn: 'åœ°çƒä»ª', emoji: 'ğŸŒ', id: 's10' },
                    { en: 'Calculator', cn: 'è®¡ç®—å™¨', emoji: 'ğŸ§®', id: 's11' },
                    { en: 'Map', cn: 'åœ°å›¾', emoji: 'ğŸ—ºï¸', id: 's12' },
                    { en: 'Desk', cn: 'ä¹¦æ¡Œ', emoji: 'ğŸ–¥ï¸', id: 's13' },
                    { en: 'Chair', cn: 'æ¤…å­', emoji: 'ğŸª‘', id: 's14' },
                    { en: 'Crayon', cn: 'èœ¡ç¬”', emoji: 'ğŸ–ï¸', id: 's15' },
                    { en: 'Highlighter', cn: 'è§å…‰ç¬”', emoji: 'ğŸ§ª', id: 's16' },
                    { en: 'Locker', cn: 'å‚¨ç‰©æŸœ', emoji: 'ğŸ”’', id: 's17' },
                    { en: 'Whiteboard', cn: 'ç™½æ¿', emoji: 'ğŸ“', id: 's18' },
                    { en: 'Folder', cn: 'æ–‡ä»¶å¤¹', emoji: 'ğŸ“‚', id: 's19' },
                    { en: 'Dictionary', cn: 'è¯å…¸', emoji: 'ğŸ“™', id: 's20' },
                ]
            },
            home: {
                name: "ç”Ÿæ´»ç”¨å“ (Household Items)",
                items: [
                    { en: 'Sofa', cn: 'æ²™å‘', emoji: 'ğŸ›‹ï¸', id: 'h1' },
                    { en: 'Lamp', cn: 'å°ç¯', emoji: 'ğŸ’¡', id: 'h2' },
                    { en: 'Clock', cn: 'æ—¶é’Ÿ', emoji: 'â°', id: 'h3' },
                    { en: 'Spoon', cn: 'å‹ºå­', emoji: 'ğŸ¥„', id: 'h4' },
                    { en: 'Plate', cn: 'ç›˜å­', emoji: 'ğŸ½ï¸', id: 'h5' },
                    { en: 'Towel', cn: 'æ¯›å·¾', emoji: 'ğŸ§–', id: 'h6' },
                    { en: 'Soap', cn: 'è‚¥çš‚', emoji: 'ğŸ§¼', id: 'h7' },
                    { en: 'Key', cn: 'é’¥åŒ™', emoji: 'ğŸ”‘', id: 'h8' },
                    { en: 'Mirror', cn: 'é•œå­', emoji: 'ğŸª', id: 'h9' },
                    { en: 'Pillow', cn: 'æ•å¤´', emoji: 'ğŸ›ï¸', id: 'h10' },
                    { en: 'Blanket', cn: 'æ¯¯å­', emoji: 'ğŸ›Œ', id: 'h11' },
                    { en: 'Toothbrush', cn: 'ç‰™åˆ·', emoji: 'ğŸ¦·', id: 'h12' },
                    { en: 'TV', cn: 'ç”µè§†', emoji: 'ğŸ“º', id: 'h13' },
                    { en: 'Phone', cn: 'ç”µè¯', emoji: 'ğŸ“', id: 'h14' },
                    { en: 'Vase', cn: 'èŠ±ç“¶', emoji: 'ğŸº', id: 'h15' },
                    { en: 'Basket', cn: 'ç¯®å­', emoji: 'ğŸ§º', id: 'h16' },
                    { en: 'Cabinet', cn: 'æŸœå­', emoji: 'ğŸ—„ï¸', id: 'h17' },
                    { en: 'Hanger', cn: 'è¡£æ¶', emoji: 'ğŸ‘š', id: 'h18' },
                    { en: 'Mop', cn: 'æ‹–æŠŠ', emoji: 'ğŸ§¹', id: 'h19' },
                    { en: 'Fan', cn: 'é£æ‰‡', emoji: 'ğŸ’¨', id: 'h20' },
                ]
            }
        };

        // *** æ–°å¢ï¼šæ··åˆä¸»é¢˜çš„è®¡ç®—é€»è¾‘ ***
        (() => {
            let allMixedItems = [];
            // æ˜ç¡®åˆ—å‡ºè¦æ··åˆçš„æ‰€æœ‰ä¸»é¢˜é”®
            const combinableKeys = ['colors', 'animals', 'fruits', 'school', 'home']; 

            combinableKeys.forEach(key => {
                if (ALL_THEMES[key] && ALL_THEMES[key].items) {
                    allMixedItems = allMixedItems.concat(ALL_THEMES[key].items);
                }
            });

            // æ·»åŠ æ··åˆä¸»é¢˜åˆ° ALL_THEMES
            ALL_THEMES.mixed = {
                name: "æ··åˆä¸»é¢˜ (All Mixed)",
                items: allMixedItems
            };
        })();
        // ********************************

        const MAX_PLAYERS = 4;
        const CARD_POOL_SIZE = 18; // æ¯æ¬¡éšæœºæŠ½å–18å¼ å¡ç‰‡

        const GAME_STATE = {
            SETUP: 'SETUP',
            POTION_SELECTION: 'POTION_SELECTION',
            REVEAL_WAIT: 'REVEAL_WAIT',
            UNRAVELING: 'UNRAVELING',
            GAME_OVER: 'GAME_OVER',
        };

        // --- å…¨å±€çŠ¶æ€ ---
        let gameState = GAME_STATE.SETUP;
        let playerCount = 2; 
        let currentThemeKey = 'animals'; // é»˜è®¤åŠ¨ç‰©ä¸»é¢˜
        let currentItems = []; // å½“å‰å›åˆä½¿ç”¨çš„ 18 ä¸ªéšæœºå•è¯
        let players = [];
        let currentPlayerIndex = 0;
        let currentUnravelerIndex = 0;
        let selectedPotions = {}; // { id: playerId | 'REVEALED' }
        let itemToConfirmId = null; 
        let safePotions = []; // IDs of safe items
        let gameLog = [];
        let message = '';

        // --- è¾…åŠ©å‡½æ•° ---
        
        // éšæœºæŠ½å– n ä¸ªå…ƒç´ çš„å‡½æ•°
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // ç¡®ä¿ä»è¯åº“ä¸­éšæœºæŠ½å– CARD_POOL_SIZE (18) ä¸ªé¡¹ç›®
        function selectRandomItems(themeKey, count = CARD_POOL_SIZE) {
            const allItems = ALL_THEMES[themeKey].items;
            const shuffled = shuffle([...allItems]);
            return shuffled.slice(0, Math.min(count, allItems.length));
        }

        const generateDefaultPlayers = (count) => {
            return Array.from({ length: count }, (_, i) => ({
                id: i + 1,
                name: `ç©å®¶ ${i + 1}`,
                isDead: false,
                isSafe: false,
            }));
        };

        const getPlayerNameById = (id) => players.find(p => p.id === id)?.name || 'æœªçŸ¥ç©å®¶';
        
        const getItemName = (id) => {
            const item = currentItems.find(i => i.id === id);
            return item ? `${item.en} (${item.cn})` : 'æœªçŸ¥';
        };

        const addLog = (entry) => {
            gameLog.push(entry);
            renderGameLog();
        };

        const setMessageText = (text) => {
            message = text;
            renderStatusPanel();
        };

        // --- æ¸²æŸ“å‡½æ•° ---

        function renderIcons() {
            if (window.lucide && window.lucide.createIcons) {
                setTimeout(() => window.lucide.createIcons(), 0);
            }
        }

        function renderPlayerStatus() {
            const container = document.getElementById('player-status-container');
            
            const playersHtml = players.map(p => {
                const isCurrent = gameState === GAME_STATE.UNRAVELING && !p.isDead && p.id === players[currentUnravelerIndex].id;
                
                let statusClass = 'bg-gray-700 border border-gray-600';
                let statusText = `<span class="text-yellow-400 font-bold text-[10px] sm:text-xs">æ´»è·ƒ</span>`;
                let icon = '<i data-lucide="smile" class="w-3 h-3 sm:w-4 sm:h-4 text-gray-400"></i>';

                if (p.isDead) {
                    statusClass = 'bg-red-900 border-2 border-red-500 opacity-60';
                    statusText = `<span class="text-red-400 font-bold flex items-center text-[10px] sm:text-xs"><i data-lucide="skull" class="w-2 h-2 mr-0.5"></i> æ·˜æ±°</span>`;
                    icon = '<i data-lucide="ghost" class="w-3 h-3 sm:w-4 sm:h-4 text-red-400"></i>';
                } else if (p.isSafe) { 
                    statusClass = 'bg-green-900 border-2 border-green-500';
                    statusText = `<span class="text-green-400 font-bold flex items-center text-[10px] sm:text-xs"><i data-lucide="trophy" class="w-2 h-2 mr-0.5"></i> è·èƒœ</span>`;
                    icon = '<i data-lucide="crown" class="w-3 h-3 sm:w-4 sm:h-4 text-yellow-400"></i>';
                } else if (isCurrent) {
                    statusClass = 'bg-indigo-700 border-2 border-indigo-400 ring-2 ring-indigo-300 animate-pulse';
                    statusText = `<span class="text-indigo-200 font-bold flex items-center text-[10px] sm:text-xs">è½®åˆ°ä½ äº†</span>`;
                }

                return `
                    <div class="p-1.5 sm:p-2 rounded-lg shadow-inner flex items-center space-x-1 sm:space-x-2 transition duration-300 ${statusClass}">
                        <div class="flex-shrink-0">${icon}</div>
                        <div class="flex-grow min-w-0">
                            <p class="font-semibold text-xs sm:text-sm text-white truncate">${p.name}</p>
                            ${statusText}
                        </div>
                    </div>
                `;
            }).join('');

            // ä½¿ç”¨ internal-scroll å…è®¸åˆ—è¡¨å†…éƒ¨æ»šåŠ¨
            container.innerHTML = `
                <div class="bg-gray-800 top-panel-p rounded-2xl shadow-xl border border-gray-700 h-full flex flex-col">
                    <h3 class="text-base sm:text-lg font-bold text-white mb-1 flex items-center space-x-1 flex-shrink-0 border-b border-gray-700 pb-1">
                        <i data-lucide="users" class="w-4 h-4 text-teal-400"></i>
                        <span>ç©å®¶</span>
                    </h3>
                    <div class="grid grid-cols-2 gap-2 flex-grow min-h-0 internal-scroll p-0.5">
                        ${playersHtml}
                    </div>
                </div>
            `;
            renderIcons();
        }

        function renderGameLog() {
            const container = document.getElementById('game-log-container');
            
            // ç§˜å¯†é€‰æ‹©é˜¶æ®µä¸æ˜¾ç¤ºæ—¥å¿—
            if (gameState === GAME_STATE.POTION_SELECTION) {
                 container.innerHTML = `
                    <div class="bg-gray-800 top-panel-p rounded-2xl shadow-xl border border-gray-700 h-full flex flex-col items-center justify-center">
                        <i data-lucide="lock" class="w-6 h-6 text-yellow-400 mb-1"></i>
                        <span class="text-sm font-medium text-gray-400">ç§˜å¯†é€‰æ‹©ä¸­...</span>
                    </div>`;
                return;
            }

            let logsToDisplay = gameLog;
            if (gameState === GAME_STATE.REVEAL_WAIT || gameState === GAME_STATE.UNRAVELING) {
                logsToDisplay = gameLog.filter(log => !log.startsWith('[ç§˜å¯†é€‰æ‹©]'));
            }

            const logHtml = [...logsToDisplay].reverse().map(log => {
                let color = 'text-gray-400';
                if (log.includes('æˆåŠŸæœ—è¯»')) color = 'text-green-300';
                if (log.includes('æ·˜æ±°')) color = 'text-red-300 font-semibold';
                
                return `<li class="text-[10px] sm:text-xs ${color} border-b border-gray-700 py-0.5 last:border-b-0">
                    ${log}
                </li>`;
            }).join('');

            // ä½¿ç”¨ internal-scroll å…è®¸æ—¥å¿—åˆ—è¡¨å†…éƒ¨æ»šåŠ¨
            container.innerHTML = `
                <div class="bg-gray-800 top-panel-p rounded-2xl shadow-xl border border-gray-700 h-full flex flex-col">
                    <h3 class="text-base sm:text-lg font-bold text-white mb-1 flex items-center space-x-1 flex-shrink-0 border-b border-gray-700 pb-1">
                        <i data-lucide="scroll-text" class="w-4 h-4 text-cyan-400"></i>
                        <span>æ¸¸æˆè®°å½•</span>
                    </h3>
                    <ul class="space-y-0.5 flex-grow min-h-0 internal-scroll p-0.5">
                        ${logHtml}
                    </ul>
                </div>
            `;
            renderIcons();
        }

        function renderItemCard(item) {
            const selectedById = selectedPotions[item.id];
            const isSelected = !!selectedById;
            
            // çŠ¶æ€åˆ¤æ–­
            const isDeadlyRevealed = selectedById === 'REVEALED';
            const isSafeConsumed = !isSelected && !safePotions.includes(item.id) && (gameState === GAME_STATE.UNRAVELING || gameState === GAME_STATE.GAME_OVER);
            
            let bgClass = 'bg-gray-700';
            let borderClass = 'border-gray-600';
            let cursorClass = 'cursor-default';
            let clickHandler = '';
            let opacityClass = '';

            // æ ·å¼é…ç½®
            const isColorTheme = currentThemeKey === 'colors' || (currentThemeKey === 'mixed' && ALL_THEMES.colors.items.some(i => i.id === item.id));
            let visualContent = '';
            let textClass = 'text-white';
            
            // æ··åˆä¸»é¢˜ä¸‹ï¼Œå¦‚æœæ˜¯é¢œè‰²å¡ç‰‡ï¼Œåˆ™æŒ‰é¢œè‰²æ¸²æŸ“
            if (item.hex) { 
                visualContent = `<div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full shadow-md mb-1 border-2 border-white/20" style="background-color: ${item.hex}"></div>`;
                if (item.hex === '#f3f4f6') { 
                    textClass = 'text-black-on-white';
                }
            } else if (item.emoji) { // å¦åˆ™æŒ‰ emoji æ¸²æŸ“
                visualContent = `<div class="text-xl sm:text-2xl">${item.emoji}</div>`;
            }

            // 1. ç§˜å¯†é€‰æ‹©é˜¶æ®µ
            if (gameState === GAME_STATE.POTION_SELECTION) {
                borderClass = 'border-indigo-500/30';
                
                if (!isSelected) {
                    // å¯é€‰çŠ¶æ€ (ç‚¹å‡»è§¦å‘ Modal)
                    bgClass = 'bg-gray-700 hover:bg-gray-600';
                    clickHandler = `handleItemSelection('${item.id}')`;
                    cursorClass = 'cursor-pointer hover:scale-[1.03] hover:shadow-xl';
                } else {
                    // å·²é€‰çŠ¶æ€
                    bgClass = 'bg-gray-700';
                    opacityClass = 'opacity-50'; // å·²é€‰å¡ç‰‡å˜æš—
                }
            } 
            // 2. è§£æ¯’/æ­ç¤ºé˜¶æ®µ
            else if (gameState === GAME_STATE.UNRAVELING || gameState === GAME_STATE.GAME_OVER || gameState === GAME_STATE.REVEAL_WAIT) {
                if (isDeadlyRevealed) {
                    bgClass = 'bg-red-900/90';
                    borderClass = 'border-red-500';
                    visualContent = `<i data-lucide="skull" class="w-6 h-6 sm:w-8 sm:h-8 text-red-200 mb-1"></i>`;
                } else if (isSafeConsumed) {
                    bgClass = 'bg-gray-800';
                    borderClass = 'border-gray-700';
                    opacityClass = 'opacity-50 grayscale';
                } else {
                    bgClass = 'bg-gray-700 hover:bg-indigo-900';
                    borderClass = 'border-indigo-500/50';
                }

                const isAvailable = gameState === GAME_STATE.UNRAVELING && !isDeadlyRevealed && !isSafeConsumed;
                if (isAvailable) {
                    clickHandler = `handleUnravelingChoice('${item.id}')`;
                    cursorClass = 'cursor-pointer hover:scale-[1.03] hover:shadow-xl hover:border-indigo-400';
                }
            }
            
            // ç´§å‡‘çš„å¡ç‰‡å†…å®¹
            const cardContent = `
                <div class="text-xs sm:text-sm font-bold ${textClass} tracking-wide text-center leading-tight">${item.en}</div>
                <div class="text-[10px] text-gray-400 mt-0.5 font-medium">${item.cn}</div>
            `;

            return `
                <div 
                    class="word-card relative rounded-xl border-2 flex flex-col items-center justify-center shadow-lg transition duration-200 select-none ${bgClass} ${borderClass} ${cursorClass} ${opacityClass}"
                    onclick="${clickHandler}"
                >
                    ${visualContent}
                    ${cardContent}
                    
                    ${isDeadlyRevealed ? '<div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-xl"><span class="text-red-400 font-bold text-xs transform -rotate-12 border-2 border-red-500 px-1 py-0.5 rounded">POISON</span></div>' : ''}
                    ${isSafeConsumed ? '<div class="absolute inset-0 flex items-center justify-center"><i data-lucide="check" class="w-8 h-8 sm:w-10 sm:h-10 text-green-500/50"></i></div>' : ''}
                </div>
            `;
        }

        function renderGrid() {
            const container = document.getElementById('potions-grid');
            const themeNameSpan = document.getElementById('current-theme-name');
            
            if (!container) return;
            
            themeNameSpan.textContent = ALL_THEMES[currentThemeKey].name.split(' ')[0]; // å–ä¸­æ–‡å

            container.innerHTML = currentItems.map(renderItemCard).join('');

            const area = document.getElementById('potion-selection-area');
            if (gameState !== GAME_STATE.SETUP) {
                area.classList.remove('hidden');
                area.classList.add('flex'); // ç¡®ä¿ flex å¸ƒå±€ç”Ÿæ•ˆ
            } else {
                area.classList.add('hidden');
                area.classList.remove('flex');
            }
            renderIcons();
        }

        function renderStatusPanel() {
            const container = document.getElementById('status-panel-container');
            let statusHeader = '';
            let statusContent = '';
            
            if (gameState === GAME_STATE.SETUP) {
                statusHeader = 'âš™ï¸ æ¸¸æˆè®¾ç½®';
                
                // ä¸»é¢˜é€‰æ‹©å™¨ HTML
                const themeOptions = Object.keys(ALL_THEMES).map(key => 
                    `<option value="${key}" ${currentThemeKey === key ? 'selected' : ''}>${ALL_THEMES[key].name}</option>`
                ).join('');

                const playerInputs = players.map(p => `
                    <div class="flex items-center space-x-1">
                        <span class="text-gray-400 w-12 text-xs">P ${p.id}</span>
                        <input
                            type="text"
                            value="${p.name}"
                            onchange="handlePlayerNameChange(${p.id}, this.value)"
                            class="flex-grow p-1 border border-gray-600 rounded-md bg-gray-700 text-white text-xs focus:border-indigo-500 outline-none"
                            placeholder="æ˜µç§°"
                        />
                    </div>
                `).join('');

                statusContent = `
                    <div class="space-y-2 flex-grow min-h-0 internal-scroll p-0.5">
                        <div class="space-y-1">
                            <label class="block text-xs font-medium text-gray-400">ä¸»é¢˜/äººæ•°</label>
                            <div class="flex space-x-2">
                                <select 
                                    onchange="handleThemeChange(this.value)"
                                    class="flex-grow p-1 border border-gray-600 rounded-md bg-gray-700 text-white text-xs focus:border-indigo-500 outline-none"
                                >
                                    ${themeOptions}
                                </select>
                                <select
                                    value="${playerCount}"
                                    onchange="handlePlayerCountChange(Number(this.value))"
                                    class="w-16 p-1 border border-gray-600 rounded-md bg-gray-700 text-white text-xs focus:border-indigo-500 outline-none"
                                >
                                    ${[2, 3, 4].map(num => `<option value="${num}" ${playerCount === num ? 'selected' : ''}>${num} äºº</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="bg-gray-700/50 p-2 rounded-lg border border-gray-700">
                            <h3 class="text-xs font-bold text-gray-300 mb-1">ç©å®¶æ˜µç§°</h3>
                            <div class="grid grid-cols-2 gap-1">
                                ${playerInputs}
                            </div>
                        </div>

                        <button
                            onclick="startGame()"
                            class="w-full py-1.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-lg hover:from-indigo-500 hover:to-purple-500 transition shadow-lg transform active:scale-95 flex items-center justify-center space-x-1 text-sm"
                        >
                            <span>å¼€å§‹æ¸¸æˆ</span>
                            <i data-lucide="play" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
            } else if (gameState === GAME_STATE.POTION_SELECTION) {
                statusHeader = 'ğŸ¤« ç§˜å¯†ä¸‹æ¯’';
                
                statusContent = `
                    <div class="text-center flex-grow flex flex-col justify-center">
                        <div class="text-xs text-gray-400 mb-1">è½®åˆ°</div>
                        <div class="text-xl sm:text-2xl font-extrabold text-yellow-300 mb-2">${players[currentPlayerIndex].name}</div>
                        
                        <div class="bg-gray-700/50 p-2 rounded-lg mb-4">
                            <p class="text-sm text-white mb-0.5">è¯·å…¶ä»–ç©å®¶ <span class="text-red-400 font-bold">é—­çœ¼</span>ï¼</p>
                            <p class="text-[10px] text-gray-300">ç‚¹å‡»å¡ç‰‡ï¼Œå¼¹çª—ç¡®è®¤è®¾ä¸ºæ¯’è¯ã€‚</p>
                        </div>

                        <div class="flex justify-center items-center space-x-1 text-xs text-gray-500">
                            <span>è¿›åº¦:</span>
                            <span class="font-mono bg-gray-700 px-1 py-0.5 rounded text-white">${Object.keys(selectedPotions).length} / ${playerCount}</span>
                        </div>
                    </div>
                `;
            } else if (gameState === GAME_STATE.REVEAL_WAIT) {
                statusHeader = 'âš ï¸ æŒ‘æˆ˜é¢„å¤‡';
                const safeCount = currentItems.length - players.length;
                statusContent = `
                    <div class="text-center flex-grow flex flex-col justify-center">
                        <i data-lucide="eye" class="w-8 h-8 text-green-400 mx-auto mb-1"></i>
                        <h3 class="text-lg font-bold text-white">å…¨å‘˜ççœ¼ï¼</h3>
                        <p class="text-gray-300 text-sm mb-3">åœºä¸Šæœ‰ <span class="text-yellow-300 font-bold">${safeCount}</span> ä¸ªå®‰å…¨å•è¯ã€‚</p>
                        <button
                            onclick="handleUnravelingStart()"
                            class="w-full py-1.5 bg-green-600 text-white font-bold rounded-lg hover:bg-green-500 transition shadow-lg text-sm"
                        >
                            å¼€å§‹æŒ‘æˆ˜
                        </button>
                    </div>
                `;
            } else if (gameState === GAME_STATE.UNRAVELING) {
                const unrevealedPoisonsCount = Object.keys(selectedPotions).filter(id => selectedPotions[id] !== 'REVEALED').length;
                const totalPotionsRemaining = safePotions.length + unrevealedPoisonsCount;
                statusHeader = 'ğŸ¤ å•è¯æŒ‘æˆ˜';
                statusContent = `
                    <div class="text-center flex-grow flex flex-col justify-center">
                        <div class="text-xs text-gray-400 mb-0.5">è½®åˆ°</div>
                        <div class="text-xl sm:text-2xl font-extrabold text-blue-300 mb-2 animate-pulse">${players[currentUnravelerIndex].name}</div>
                        
                        <div class="bg-indigo-900/30 border border-indigo-500/30 p-2 rounded-lg mb-2">
                            <p class="text-gray-200 text-xs">è¯·å¤§å£°æœ—è¯»å•è¯å¹¶ç‚¹å‡»ï¼</p>
                        </div>

                        <div class="grid grid-cols-2 gap-1 text-xs text-gray-400">
                            <div class="bg-gray-700 p-1 rounded">å‰©ä½™: <span class="text-white font-bold">${totalPotionsRemaining}</span></div>
                            <div class="bg-gray-700 p-1 rounded">æ¯’è¯: <span class="text-red-400 font-bold">${unrevealedPoisonsCount}</span></div>
                        </div>
                    </div>
                `;
            } else if (gameState === GAME_STATE.GAME_OVER) {
                statusHeader = 'ğŸ† æ¸¸æˆç»“æŸ';
                const winners = players.filter(p => p.isSafe);
                
                let resultHtml = winners.length > 0 ? `
                    <div class="mb-2">
                        <div class="text-4xl mb-1">ğŸ‰</div>
                        <div class="text-lg font-bold text-green-400">è·èƒœè€…</div>
                        <div class="text-xl text-white font-extrabold">${winners.map(p => p.name).join(' & ')}</div>
                    </div>
                ` : `
                    <div class="mb-2">
                        <div class="text-4xl mb-1">ğŸ’€</div>
                        <div class="text-lg font-bold text-red-400">å…¨å‘˜æ·˜æ±°</div>
                    </div>
                `;
                    
                statusContent = `
                    <div class="text-center flex-grow flex flex-col justify-center">
                        ${resultHtml}
                        <button
                            onclick="handleReset()"
                            class="w-full py-1.5 bg-white text-indigo-900 font-bold rounded-lg hover:bg-gray-100 transition shadow-lg flex items-center justify-center space-x-1 text-sm mt-2"
                        >
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            <span>å†ç©ä¸€æ¬¡</span>
                        </button>
                    </div>
                `;
            }

            // ç´§å‡‘çš„é¢æ¿ç»“æ„
            container.innerHTML = `
                <div class="bg-gray-800 top-panel-p rounded-2xl shadow-2xl border border-gray-700 h-full flex flex-col">
                    <h2 class="text-base sm:text-lg font-bold text-white flex items-center space-x-1 border-b border-gray-700 pb-1 mb-2 flex-shrink-0">
                        <span class="text-base">${statusHeader.split(' ')[0]}</span>
                        <span>${statusHeader.split(' ')[1]}</span>
                    </h2>
                    ${statusContent}
                    <p class="text-xs text-center text-red-400 font-medium mt-1 h-3 flex-shrink-0">${message}</p>
                </div>
            `;
            renderIcons();
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        function initializeGame() {
            players = generateDefaultPlayers(playerCount);
            currentItems = selectRandomItems(currentThemeKey); 
            
            renderStatusPanel();
            renderPlayerStatus();
            renderGameLog();
            renderGrid();
        }

        window.handleThemeChange = (key) => {
            currentThemeKey = key;
            currentItems = selectRandomItems(currentThemeKey);
            renderGrid();
        };

        window.handlePlayerCountChange = (count) => {
            playerCount = count;
            players = generateDefaultPlayers(count);
            renderStatusPanel();
            renderPlayerStatus();
        };

        window.handlePlayerNameChange = (id, newName) => {
            players = players.map(p => p.id === id ? { ...p, name: newName } : p);
        };

        window.startGame = () => {
            if (players.some(p => !p.name.trim())) {
                 setMessageText('è¯·å¡«å†™æ‰€æœ‰ç©å®¶çš„æ˜µç§°ï¼');
                 return;
            }
            if (playerCount > CARD_POOL_SIZE) {
                setMessageText(`ç©å®¶äººæ•° (${playerCount}) ä¸èƒ½è¶…è¿‡å¡ç‰‡æ€»æ•° (${CARD_POOL_SIZE})ï¼`);
                return;
            }

            currentItems = selectRandomItems(currentThemeKey); 

            // ç¡®ä¿ç©å®¶çŠ¶æ€åœ¨å¼€å§‹æ–°æ¸¸æˆæ—¶è¢«é‡ç½®
            players = players.map(p => ({ ...p, isDead: false, isSafe: false })); 
            gameState = GAME_STATE.POTION_SELECTION;
            currentPlayerIndex = 0;
            currentUnravelerIndex = 0; // é‡ç½®è§£æ¯’é¡ºåº
            selectedPotions = {}; 
            itemToConfirmId = null; 
            safePotions = [];

            setMessageText(`è¯· ${players[0].name} é€‰æ‹©ä¸€ä¸ªå•è¯ä½œä¸ºæ¯’è¯ã€‚`);
            
            renderStatusPanel();
            renderPlayerStatus(); // ç¡®ä¿çŠ¶æ€æ æ˜¾ç¤ºä¸ºæ´»è·ƒ
            renderGameLog(); 
            renderGrid();
        };

        // *** ç§˜å¯†é€‰æ‹©ï¼šç‚¹å‡»å¡ç‰‡ï¼Œæ‰“å¼€æ¨¡æ€æ¡†ç¡®è®¤ ***
        window.handleItemSelection = (itemId) => {
            if (selectedPotions[itemId]) {
                setMessageText('è¿™ä¸ªå•è¯å·²ç»è¢«é€‰äº†ï¼Œæ¢ä¸€ä¸ªå§ï¼');
                return;
            }
            
            showConfirmationModal(itemId);
        };

        function showConfirmationModal(itemId) {
            const item = currentItems.find(i => i.id === itemId);
            if (!item) return;

            itemToConfirmId = itemId;
            const currentName = players[currentPlayerIndex].name;

            const modalContent = document.getElementById('modal-content');
            
            // ä¸ºäº†è®©å¡ç‰‡åœ¨ Modal ä¸­ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤ºï¼Œå°†å¡ç‰‡çš„æ ·å¼ä»£ç ç®€åŒ–
            let visualContent = '';
            let textClass = 'text-white';
            
            if (item.hex) { 
                visualContent = `<div class="w-8 h-8 rounded-full shadow-md mb-2 border-2 border-white/20 mx-auto" style="background-color: ${item.hex}"></div>`;
                if (item.hex === '#f3f4f6') { 
                    textClass = 'text-black-on-white';
                }
            } else if (item.emoji) {
                visualContent = `<div class="text-4xl mb-2">${item.emoji}</div>`;
            }

            modalContent.innerHTML = `
                <h3 class="text-xl font-bold text-yellow-300 mb-2 text-center">ğŸ¤« ç¡®è®¤ä¸‹æ¯’</h3>
                <p class="text-sm text-gray-300 mb-4 text-center">ç©å®¶ <span class="font-bold text-white">${currentName}</span> ç¡®å®šé€‰æ‹©ä»¥ä¸‹å•è¯ä½œä¸ºæ¯’è¯å—ï¼Ÿ</p>
                
                <div class="bg-gray-700 border-2 border-yellow-500 rounded-xl p-4 mb-4 flex flex-col items-center justify-center shadow-lg">
                    ${visualContent}
                    <div class="text-lg sm:text-xl font-bold ${textClass} tracking-wide text-center leading-tight">${item.en}</div>
                    <div class="text-sm text-gray-400 mt-1 font-medium">${item.cn}</div>
                </div>

                <div class="flex space-x-3">
                    <button
                        onclick="handleCancelSelection()"
                        class="flex-grow py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-500 transition shadow-md text-sm"
                    >
                        <i data-lucide="x" class="w-4 h-4 mr-1 inline-block"></i>
                        å–æ¶ˆ
                    </button>
                    <button
                        onclick="handleConfirmSelection()"
                        class="flex-grow py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-500 transition shadow-md text-sm"
                    >
                        <i data-lucide="skull" class="w-4 h-4 mr-1 inline-block"></i>
                        ç¡®è®¤ä¸ºæ¯’è¯
                    </button>
                </div>
            `;

            document.getElementById('confirmation-modal').classList.remove('hidden');
            document.getElementById('confirmation-modal').classList.add('flex');
            renderIcons();
            setMessageText(''); // éšè—ä¸»é¢æ¿çš„é”™è¯¯ä¿¡æ¯
        }

        // *** ç§˜å¯†é€‰æ‹©ï¼šç¡®è®¤æ­¥éª¤ï¼Œå®Œæˆé€‰æ‹©å¹¶åˆ‡æ¢ç©å®¶ ***
        window.handleConfirmSelection = () => {
            if (!itemToConfirmId) return;

            const itemId = itemToConfirmId;
            const currentPlayer = players[currentPlayerIndex];
            
            selectedPotions[itemId] = currentPlayer.id;
            
            addLog(`[ç§˜å¯†é€‰æ‹©] ${currentPlayer.name} é€‰æ‹©äº†æ¯’è¯ ${getItemName(itemId)}`);
            
            // å…³é—­å¼¹çª—å¹¶æ¸…ç©ºæš‚å­˜
            handleCancelSelection(); 

            const nextPlayerIndex = currentPlayerIndex + 1;

            if (nextPlayerIndex < players.length) {
                currentPlayerIndex = nextPlayerIndex;
                setMessageText(`å·²è®°å½•ã€‚è¯·é—­çœ¼ï¼Œæ¢ ${players[nextPlayerIndex].name} æ“ä½œã€‚`);
            } else {
                safePotions = currentItems.filter(i => !selectedPotions[i.id]).map(i => i.id);
                gameState = GAME_STATE.REVEAL_WAIT;
                currentUnravelerIndex = 0;
                setMessageText('æ‰€æœ‰æ¯’è¯å·²å°±ä½ï¼');
                addLog(`[é˜¶æ®µ] æ¯’è¯åŸ‹è—å®Œæ¯•ï¼ŒæŒ‘æˆ˜å¼€å§‹ã€‚`);
            }
            
            renderGrid(); 
            renderStatusPanel();
        };

        window.handleCancelSelection = () => {
            itemToConfirmId = null;
            document.getElementById('confirmation-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.remove('flex');
            // æ¢å¤æç¤ºï¼Œä½†ä¸æ¸…ç©ºå¯èƒ½å­˜åœ¨çš„å…¶ä»–ä¿¡æ¯
            if (gameState === GAME_STATE.POTION_SELECTION) {
                 setMessageText(`è¯· ${players[currentPlayerIndex].name} é€‰æ‹©ä¸€ä¸ªå•è¯ä½œä¸ºæ¯’è¯ã€‚`);
            }
            renderGrid();
        };

        window.handleUnravelingStart = () => {
            gameState = GAME_STATE.UNRAVELING;
            players = players.map(p => ({ ...p, isDead: false, isSafe: false })); 
            setMessageText(`è¯· ${players[currentUnravelerIndex].name} æœ—è¯»å¹¶é€‰æ‹©ä¸€ä¸ªå•è¯ã€‚`);
            renderStatusPanel();
            renderGrid();
            renderPlayerStatus();
            renderGameLog();
        };

        function checkGameOverAndAdvance() {
            const unrevealedPoisons = Object.keys(selectedPotions).filter(id => selectedPotions[id] !== 'REVEALED').length;
            const remainingSafe = safePotions.length;
            let activePlayers = players.filter(p => !p.isDead);

            // 1. å…¨å‘˜æ·˜æ±°
            if (activePlayers.length === 0) {
                gameState = GAME_STATE.GAME_OVER;
                setMessageText('æ¸¸æˆç»“æŸï¼Œæ— äººå¹¸å­˜ã€‚');
                addLog('--- å…¨å‘˜æ·˜æ±° ---');
                return true;
            }

            // *** æ ¸å¿ƒé€»è¾‘ï¼šä»…å‰©ä¸€äººæ—¶ï¼Œæ­¤äººèƒœåˆ© ***
            if (activePlayers.length === 1) {
                gameState = GAME_STATE.GAME_OVER;
                const winner = activePlayers[0];
                players = players.map(p => ({ ...p, isSafe: p.id === winner.id }));
                setMessageText(`${winner.name} è·èƒœï¼`);
                addLog(`--- ${winner.name} æœ€ç»ˆè·èƒœ ---`);
                return true;
            }
            // *** ä¿®æ­£ç»“æŸ ***

            // 3. å¡æ± æ¸…ç©º (æ‰€æœ‰å¹¸å­˜è€…è·èƒœ)
            if (remainingSafe === 0 && unrevealedPoisons === 0) {
                gameState = GAME_STATE.GAME_OVER;
                players = players.map(p => ({ ...p, isSafe: !p.isDead })); 
                setMessageText('æ­å–œï¼æ‰€æœ‰å•è¯æŒ‘æˆ˜å®Œæˆï¼');
                addLog('--- å®Œç¾é€šå…³ ---');
                return true;
            }

            let nextIndex = currentUnravelerIndex;
            let attempts = 0;
            // å¾ªç¯æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ´»è·ƒçš„ç©å®¶
            do {
                nextIndex = (nextIndex + 1) % players.length;
                attempts++;
            } while (players[nextIndex].isDead && attempts <= players.length);

            if (attempts <= players.length) {
                currentUnravelerIndex = nextIndex;
                setMessageText(`è½®åˆ° ${players[currentUnravelerIndex].name}ã€‚`);
                return false;
            }
            return true; 
        }

        window.handleUnravelingChoice = (itemId) => {
            if (gameState !== GAME_STATE.UNRAVELING) return;

            const player = players[currentUnravelerIndex];
            const itemName = getItemName(itemId);

            if (selectedPotions[itemId]) {
                const killerId = selectedPotions[itemId];
                const killer = players.find(p => p.id === killerId);
                
                players = players.map(p => p.id === player.id ? { ...p, isDead: true } : p);
                selectedPotions[itemId] = 'REVEALED';
                
                addLog(`ğŸ’€ ${player.name} é€‰ä¸­äº† ${itemName} (æ¥è‡ª ${killer.name} çš„æ¯’è¯)ï¼æ·˜æ±°ï¼`);
            } else {
                safePotions = safePotions.filter(id => id !== itemId);
                addLog(`âœ¨ ${player.name} æˆåŠŸæœ—è¯»: ${itemName}`);
            }

            checkGameOverAndAdvance();
            
            renderPlayerStatus();
            renderGrid();
            renderStatusPanel();
            renderGameLog();
        };

        window.handleReset = () => {
            gameState = GAME_STATE.SETUP;
            currentPlayerIndex = 0;
            currentUnravelerIndex = 0;
            selectedPotions = {};
            itemToConfirmId = null;
            safePotions = [];
            gameLog = [];
            message = '';
            
            // ç¡®ä¿é‡ç½®ç©å®¶çŠ¶æ€
            players = players.map(p => ({ ...p, isDead: false, isSafe: false })); 

            currentItems = selectRandomItems(currentThemeKey);
            
            renderStatusPanel();
            renderPlayerStatus();
            renderGameLog();
            renderGrid();
        };

        // å¯åŠ¨
        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>