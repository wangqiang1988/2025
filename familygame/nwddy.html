<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥³å·«çš„æ¯’è¯å•è¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        
        /* ------------------ æ ¸å¿ƒä¿®æ­£ 1ï¼šå…è®¸é¡µé¢æ»šåŠ¨ ------------------ */
        /* å…è®¸å†…å®¹åœ¨çª—å£è¿‡å°æ—¶å‘ä¸‹æº¢å‡ºå¹¶å‡ºç°å‚ç›´æ»šåŠ¨æ¡ */
        html, body {
            min-height: 100%; 
        }
        
        /* ------------------ æ ¸å¿ƒä¿®æ­£ 2ï¼šç§»é™¤å¼ºåˆ¶ç­‰æ¯”ç¼©æ”¾çš„ font-size ------------------ */
        body {
            font-size: 16px; 
        }
        
        /* å•è¯å¡ç½‘æ ¼ï¼šé€‚åº”å®¹å™¨å¤§å°ï¼Œä¿æŒç´§å‡‘ï¼Œå¹¶åˆ©ç”¨æ‰€æœ‰å‚ç›´ç©ºé—´ */
        .potion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            grid-auto-rows: 1fr; 
            gap: 0.5rem; 
            height: 100%; 
            overflow: hidden; 
        }

        /* åª’ä½“æŸ¥è¯¢ï¼šåœ¨å¤§å±å¹•ä¸Šå¼ºåˆ¶ 6 åˆ— x 3 è¡Œå¸ƒå±€ä»¥å®Œç¾å®¹çº³ 18 å¼ å¡ */
        @media (min-width: 1024px) { /* lg: breakpoint */
            .potion-grid {
                grid-template-columns: repeat(6, 1fr); 
                grid-template-rows: repeat(3, 1fr);  
            }
        }
        
        .top-panel-p {
            padding: 0.75rem; 
        }
        
        .word-card {
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.25rem;
            text-align: center;
            height: 100%;
        }
        .text-black-on-white {
             color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-2 sm:p-4 flex flex-col min-h-full">

    <header class="text-center mb-0.5 sm:mb-1 flex-shrink-0">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-400 tracking-wider">
            <span class="inline-block transform -rotate-6">ğŸ“š</span> å¥³å·«çš„æ¯’è¯å•è¯ç‰ˆ
        </h1>
    </header>

    <main id="game-container" class="max-w-7xl mx-auto w-full flex-grow min-h-0 flex flex-col space-y-2 sm:space-y-3">
        
        <div class="top-panel-group flex-shrink-0 grid grid-cols-1 lg:grid-cols-2 gap-2 sm:gap-3" style="flex-basis: 35%;">
            
            <div id="status-panel-container" class="h-full">
            </div>

            <div id="player-status-container" class="h-full">
            </div>
        </div>

        <div id="potion-selection-area" class="bg-gray-800 p-3 rounded-3xl shadow-3xl border-4 border-dashed border-indigo-600 flex-grow min-h-0 flex flex-col">
            <h2 class="text-xl sm:text-2xl font-bold text-white mb-1 text-center flex-shrink-0">
                <span id="current-theme-name">å•è¯</span>æ±  (å…± 18 å¼ )
            </h2>
            <div id="potions-grid" class="potion-grid">
                </div>
        </div>
    </main>
    
    <div id="confirmation-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div id="modal-content" class="bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700">
            </div>
    </div>


    <script>
        // --- è¯åº“é…ç½® (Themes) ---
        const ALL_THEMES = {
            colors: {
                name: "é¢œè‰² (Colors)",
                items: [
                    { en: 'Red', cn: 'çº¢è‰²', hex: '#ef4444', id: 'c1' },
                    { en: 'Blue', cn: 'è“è‰²', hex: '#3b82f6', id: 'c2' },
                    { en: 'Green', cn: 'ç»¿è‰²', hex: '#22c55e', id: 'c3' },
                    { en: 'Yellow', cn: 'é»„è‰²', hex: '#eab308', id: 'c4' },
                    { en: 'Purple', cn: 'ç´«è‰²', hex: '#9333ea', id: 'c5' },
                    { en: 'Orange', cn: 'æ©™è‰²', hex: '#f97316', id: 'c6' },
                    { en: 'Pink', cn: 'ç²‰è‰²', hex: '#db2777', id: 'c7' },
                    { en: 'Black', cn: 'é»‘è‰²', hex: '#1f2937', id: 'c8' },
                    { en: 'White', cn: 'ç™½è‰²', hex: '#f3f4f6', txt: '#000', id: 'c9' },
                    { en: 'Gray', cn: 'ç°è‰²', hex: '#6b7280', id: 'c10' },
                    { en: 'Brown', cn: 'æ£•è‰²', hex: '#78350f', id: 'c11' },
                    { en: 'Cyan', cn: 'é’è‰²', hex: '#06b6d4', id: 'c12' },
                    { en: 'Gold', cn: 'é‡‘è‰²', emoji: 'ğŸ¥‡', id: 'c13' },
                    { en: 'Silver', cn: 'é“¶è‰²', emoji: 'ğŸ¥ˆ', id: 'c14' },
                    { en: 'Lime', cn: 'é…¸æ©™ç»¿', emoji: 'ğŸŸ¢', id: 'c15' },
                    { en: 'Violet', cn: 'ç´«ç½—å…°', emoji: 'ğŸŸª', id: 'c16' },
                    { en: 'Indigo', cn: 'é›é’', emoji: 'ğŸŸ¦', id: 'c17' },
                    { en: 'Teal', cn: 'è“ç»¿', emoji: 'ğŸ’', id: 'c18' },
                    { en: 'Maroon', cn: 'è¤çº¢è‰²', emoji: 'ğŸŸ¤', id: 'c19' },
                    { en: 'Navy', cn: 'æµ·å†›è“', emoji: 'ğŸ”µ', id: 'c20' }
                ]
            },
            animals: {
                name: "åŠ¨ç‰© (Animals)",
                items: [
                    { en: 'Lion', cn: 'ç‹®å­', emoji: 'ğŸ¦', id: 'a1' },
                    { en: 'Tiger', cn: 'è€è™', emoji: 'ğŸ¯', id: 'a2' },
                    { en: 'Elephant', cn: 'å¤§è±¡', emoji: 'ğŸ˜', id: 'a3' },
                    { en: 'Monkey', cn: 'çŒ´å­', emoji: 'ğŸ’', id: 'a4' },
                    { en: 'Dog', cn: 'ç‹—', emoji: 'ğŸ¶', id: 'a5' },
                    { en: 'Cat', cn: 'çŒ«', emoji: 'ğŸ±', id: 'a6' },
                    { en: 'Rabbit', cn: 'å…”å­', emoji: 'ğŸ°', id: 'a7' },
                    { en: 'Bear', cn: 'ç†Š', emoji: 'ğŸ»', id: 'a8' },
                    { en: 'Panda', cn: 'ç†ŠçŒ«', emoji: 'ğŸ¼', id: 'a9' },
                    { en: 'Fox', cn: 'ç‹ç‹¸', emoji: 'ğŸ¦Š', id: 'a10' },
                    { en: 'Pig', cn: 'çŒª', emoji: 'ğŸ·', id: 'a11' },
                    { en: 'Cow', cn: 'ç‰›', emoji: 'ğŸ®', id: 'a12' },
                    { en: 'Sheep', cn: 'ç¾Š', emoji: 'ğŸ‘', id: 'a13' },
                    { en: 'Horse', cn: 'é©¬', emoji: 'ğŸ´', id: 'a14' },
                    { en: 'Zebra', cn: 'æ–‘é©¬', emoji: 'ğŸ¦“', id: 'a15' },
                    { en: 'Giraffe', cn: 'é•¿é¢ˆé¹¿', emoji: 'ğŸ¦’', id: 'a16' },
                    { en: 'Snake', cn: 'è›‡', emoji: 'ğŸ', id: 'a17' },
                    { en: 'Bird', cn: 'é¸Ÿ', emoji: 'ğŸ¦', id: 'a18' },
                    { en: 'Fish', cn: 'é±¼', emoji: 'ğŸŸ', id: 'a19' },
                    { en: 'Shark', cn: 'é²¨é±¼', emoji: 'ğŸ¦ˆ', id: 'a20' },
                    { en: 'Frog', cn: 'é’è›™', emoji: 'ğŸ¸', id: 'a21' },
                    { en: 'Whale', cn: 'é²¸é±¼', emoji: 'ğŸ³', id: 'a22' },
                ]
            },
            fruits: {
                name: "æ°´æœ (Fruits)",
                items: [
                    { en: 'Apple', cn: 'è‹¹æœ', emoji: 'ğŸ', id: 'f1' },
                    { en: 'Banana', cn: 'é¦™è•‰', emoji: 'ğŸŒ', id: 'f2' },
                    { en: 'Grape', cn: 'è‘¡è„', emoji: 'ğŸ‡', id: 'f3' },
                    { en: 'Orange', cn: 'æ©™å­', emoji: 'ğŸŠ', id: 'f4' },
                    { en: 'Lemon', cn: 'æŸ æª¬', emoji: 'ğŸ‹', id: 'f5' },
                    { en: 'Watermelon', cn: 'è¥¿ç“œ', emoji: 'ğŸ‰', id: 'f6' },
                    { en: 'Strawberry', cn: 'è‰è“', emoji: 'ğŸ“', id: 'f7' },
                    { en: 'Peach', cn: 'æ¡ƒå­', emoji: 'ğŸ‘', id: 'f8' },
                    { en: 'Cherry', cn: 'æ¨±æ¡ƒ', emoji: 'ğŸ’', id: 'f9' },
                    { en: 'Pear', cn: 'æ¢¨', emoji: 'ğŸ', id: 'f10' },
                    { en: 'Pineapple', cn: 'è è', emoji: 'ğŸ', id: 'f11' },
                    { en: 'Coconut', cn: 'æ¤°å­', emoji: 'ğŸ¥¥', id: 'f12' },
                    { en: 'Mango', cn: 'èŠ’æœ', emoji: 'ğŸ¥­', id: 'f13' },
                    { en: 'Kiwi', cn: 'çŒ•çŒ´æ¡ƒ', emoji: 'ğŸ¥', id: 'f14' },
                    { en: 'Avocado', cn: 'ç‰›æ²¹æœ', emoji: 'ğŸ¥‘', id: 'f15' },
                    { en: 'Melon', cn: 'ç”œç“œ', emoji: 'ğŸˆ', id: 'f16' },
                    { en: 'Tomato', cn: 'è¥¿çº¢æŸ¿', emoji: 'ğŸ…', id: 'f17' },
                    { en: 'Blueberry', cn: 'è“è“', emoji: 'ğŸ«', id: 'f18' },
                    { en: 'Raspberry', cn: 'æ ‘è“', emoji: 'ğŸ‡', id: 'f19' },
                    { en: 'Lime', cn: 'é’æŸ ', emoji: 'ğŸŸ¢', id: 'f20' },
                    { en: 'Fig', cn: 'æ— èŠ±æœ', emoji: 'ğŸŸ£', id: 'f21' },
                    { en: 'Plum', cn: 'æå­', emoji: 'ğŸ«', id: 'f22' }
                ]
            },
            school: {
                name: "å­¦ä¹ ç”¨å…· (School Supplies)",
                items: [
                    { en: 'Pen', cn: 'é’¢ç¬”', emoji: 'ğŸ–Šï¸', id: 's1' },
                    { en: 'Pencil', cn: 'é“…ç¬”', emoji: 'âœï¸', id: 's2' },
                    { en: 'Eraser', cn: 'æ©¡çš®', emoji: 'â¬œ', id: 's3' },
                    { en: 'Notebook', cn: 'ç¬”è®°æœ¬', emoji: 'ğŸ““', id: 's4' },
                    { en: 'Book', cn: 'ä¹¦', emoji: 'ğŸ“–', id: 's5' },
                    { en: 'Ruler', cn: 'å°ºå­', emoji: 'ğŸ“', id: 's6' },
                    { en: 'Backpack', cn: 'èƒŒåŒ…', emoji: 'ğŸ’', id: 's7' },
                    { en: 'Scissors', cn: 'å‰ªåˆ€', emoji: 'âœ‚ï¸', id: 's8' },
                    { en: 'Glue', cn: 'èƒ¶æ°´', emoji: 'ğŸ’§', id: 's9' },
                    { en: 'Globe', cn: 'åœ°çƒä»ª', emoji: 'ğŸŒ', id: 's10' },
                    { en: 'Calculator', cn: 'è®¡ç®—å™¨', emoji: 'ğŸ§®', id: 's11' },
                    { en: 'Map', cn: 'åœ°å›¾', emoji: 'ğŸ—ºï¸', id: 's12' },
                    { en: 'Desk', cn: 'ä¹¦æ¡Œ', emoji: 'ğŸ–¥ï¸', id: 's13' },
                    { en: 'Chair', cn: 'æ¤…å­', emoji: 'ğŸª‘', id: 's14' },
                    { en: 'Crayon', cn: 'èœ¡ç¬”', emoji: 'ğŸ–ï¸', id: 's15' },
                    { en: 'Highlighter', cn: 'è§å…‰ç¬”', emoji: 'ğŸ§ª', id: 's16' },
                    { en: 'Locker', cn: 'å‚¨ç‰©æŸœ', emoji: 'ğŸ”’', id: 's17' },
                    { en: 'Whiteboard', cn: 'ç™½æ¿', emoji: 'ğŸ“', id: 's18' },
                    { en: 'Folder', cn: 'æ–‡ä»¶å¤¹', emoji: 'ğŸ“‚', id: 's19' },
                    { en: 'Dictionary', cn: 'è¯å…¸', emoji: 'ğŸ“™', id: 's20' },
                ]
            },
            home: {
                name: "ç”Ÿæ´»ç”¨å“ (Household Items)",
                items: [
                    { en: 'Sofa', cn: 'æ²™å‘', emoji: 'ğŸ›‹ï¸', id: 'h1' },
                    { en: 'Lamp', cn: 'å°ç¯', emoji: 'ğŸ’¡', id: 'h2' },
                    { en: 'Clock', cn: 'æ—¶é’Ÿ', emoji: 'â°', id: 'h3' },
                    { en: 'Spoon', cn: 'å‹ºå­', emoji: 'ğŸ¥„', id: 'h4' },
                    { en: 'Plate', cn: 'ç›˜å­', emoji: 'ğŸ½ï¸', id: 'h5' },
                    { en: 'Towel', cn: 'æ¯›å·¾', emoji: 'ğŸ§–', id: 'h6' },
                    { en: 'Soap', cn: 'è‚¥çš‚', emoji: 'ğŸ§¼', id: 'h7' },
                    { en: 'Key', cn: 'é’¥åŒ™', emoji: 'ğŸ”‘', id: 'h8' },
                    { en: 'Mirror', cn: 'é•œå­', emoji: 'ğŸª', id: 'h9' },
                    { en: 'Pillow', cn: 'æ•å¤´', emoji: 'ğŸ›ï¸', id: 'h10' },
                    { en: 'Blanket', cn: 'æ¯¯å­', emoji: 'ğŸ›Œ', id: 'h11' },
                    { en: 'Toothbrush', cn: 'ç‰™åˆ·', emoji: 'ğŸ¦·', id: 'h12' },
                    { en: 'TV', cn: 'ç”µè§†', emoji: 'ğŸ“º', id: 'h13' },
                    { en: 'Phone', cn: 'ç”µè¯', emoji: 'ğŸ“', id: 'h14' },
                    { en: 'Vase', cn: 'èŠ±ç“¶', emoji: 'ğŸº', id: 'h15' },
                    { en: 'Basket', cn: 'ç¯®å­', emoji: 'ğŸ§º', id: 'h16' },
                    { en: 'Cabinet', cn: 'æŸœå­', emoji: 'ğŸ—„ï¸', id: 'h17' },
                    { en: 'Hanger', cn: 'è¡£æ¶', emoji: 'ğŸ‘š', id: 'h18' },
                    { en: 'Mop', cn: 'æ‹–æŠŠ', emoji: 'ğŸ§¹', id: 'h19' },
                    { en: 'Fan', cn: 'é£æ‰‡', emoji: 'ğŸ’¨', id: 'h20' },
                ]
            }
        };

        // *** æ··åˆä¸»é¢˜çš„è®¡ç®—é€»è¾‘ ***
        (() => {
            let allMixedItems = [];
            const combinableKeys = ['colors', 'animals', 'fruits', 'school', 'home']; 

            combinableKeys.forEach(key => {
                if (ALL_THEMES[key] && ALL_THEMES[key].items) {
                    allMixedItems = allMixedItems.concat(ALL_THEMES[key].items);
                }
            });

            ALL_THEMES.mixed = {
                name: "æ··åˆä¸»é¢˜ (All Mixed)",
                items: allMixedItems
            };
        })();
        // ********************************

        const MAX_PLAYERS = 4;
        const CARD_POOL_SIZE = 18; 

        const GAME_STATE = {
            SETUP: 'SETUP',
            POTION_SELECTION: 'POTION_SELECTION',
            REVEAL_WAIT: 'REVEAL_WAIT',
            UNRAVELING: 'UNRAVELING',
            GAME_OVER: 'GAME_OVER',
        };

        // --- å…¨å±€çŠ¶æ€ ---
        let gameState = GAME_STATE.SETUP;
        let playerCount = 2; 
        let currentThemeKey = 'animals'; 
        let currentItems = []; 
        let players = [];
        let currentPlayerIndex = 0;
        let currentUnravelerIndex = 0;
        // selectedPotions å­˜å‚¨ { itemId: [playerId1, playerId2, ...], id2: 'REVEALED', ... }
        let selectedPotions = {}; 
        let itemToConfirmId = null; 
        let safePotions = []; 
        let message = '';
        

        // --- è¾…åŠ©å‡½æ•° ---
        
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function selectRandomItems(themeKey, count = CARD_POOL_SIZE) {
            const allItems = ALL_THEMES[themeKey].items;
            const shuffled = shuffle([...allItems]);
            return shuffled.slice(0, Math.min(count, allItems.length));
        }

        const generateDefaultPlayers = (count) => {
            return Array.from({ length: count }, (_, i) => ({
                id: i + 1,
                name: `ç©å®¶ ${i + 1}`,
                isDead: false,
                isSafe: false,
            }));
        };

        const getItemName = (id) => {
            const item = currentItems.find(i => i.id === id);
            return item ? `${item.en} (${item.cn})` : 'æœªçŸ¥';
        };

        const setMessageText = (text) => {
            message = text;
            renderStatusPanel();
        };

        function isItemPoison(itemId) {
            const status = selectedPotions[itemId];
            // æ¯’è¯ï¼šæ˜¯æ•°ç»„ï¼ˆå­˜å‚¨äº†ç©å®¶IDï¼‰
            return status && Array.isArray(status) && status.length > 0;
        }

        // --- æ¸²æŸ“å‡½æ•° ---

        function renderIcons() {
            if (window.lucide && window.lucide.createIcons) {
                setTimeout(() => window.lucide.createIcons(), 0);
            }
        }

        function renderItemCard(item) {
            const isPoison = isItemPoison(item.id); 
            const isRevealedPoison = selectedPotions[item.id] === 'REVEALED';
            
            let baseClass = 'word-card rounded-xl shadow-lg cursor-pointer transform hover:scale-[1.02] active:scale-[0.98] transition duration-150';
            let contentClass = 'bg-gray-700/80 text-white border-2 border-gray-600/50';
            let textClass = 'text-white';
            let visualContent = '';
            let dataAction = ''; 
            
            // ç¡®å®šçŠ¶æ€å’Œç‚¹å‡»è¡Œä¸º
            if (gameState === GAME_STATE.SETUP) {
                baseClass = 'word-card rounded-xl shadow-lg cursor-default opacity-80';
                dataAction = '';
            } else if (gameState === GAME_STATE.POTION_SELECTION) {
                // ç§˜å¯†ä¸‹æ¯’é˜¶æ®µï¼šå§‹ç»ˆä¿æŒå¡ç‰‡å¤–è§‚ä¸€è‡´ï¼Œä¸”å¯ç‚¹å‡» (æ— é»„æ¡†)
                dataAction = `onclick="handleItemSelection('${item.id}')"`;
                baseClass += ' hover:bg-yellow-800/20'; 
                
            } else if (gameState === GAME_STATE.REVEAL_WAIT) {
                // æ­ç¤ºç­‰å¾…é˜¶æ®µï¼šä¸å¯ç‚¹å‡»
                baseClass = 'word-card rounded-xl shadow-lg cursor-default opacity-90';
                dataAction = '';

            } else if (gameState === GAME_STATE.UNRAVELING) {
                // æŒ‘æˆ˜è§£æ¯’é˜¶æ®µ
                
                if (isRevealedPoison) {
                    // å·²æ­ç¤ºçš„æ¯’è¯ï¼šä¸å¯ç‚¹å‡»ï¼Œæ˜¾ç¤ºæ­»äº¡è‰²
                    contentClass = 'bg-red-900 border-4 border-red-500 animate-pulse';
                    dataAction = 'onclick=""'; 
                    baseClass = 'word-card rounded-xl shadow-lg cursor-default';
                } else if (!isPoison && !safePotions.includes(item.id)) {
                    // å·²ç»è¢«æœ—è¯»çš„å®‰å…¨è¯ï¼šä¸å¯ç‚¹å‡»ï¼Œæ˜¾ç¤ºç»¿è‰²è¾¹æ¡†ï¼ˆå·²æœ—è¯»çš„å®‰å…¨è¯ï¼‰
                    contentClass = 'bg-green-900/50 border-4 border-green-500 opacity-60';
                    dataAction = 'onclick=""'; 
                    baseClass = 'word-card rounded-xl shadow-lg cursor-default';
                } else {
                    // å¾…æœ—è¯»çš„è¯æ±‡ï¼ˆæ¯’è¯æˆ–å®‰å…¨è¯ï¼‰ï¼šå¯ç‚¹å‡»
                    dataAction = `onclick="handleUnravelingChoice('${item.id}')"`;
                    baseClass += ' hover:scale-[1.05] active:scale-[0.95]';
                    
                    // *** æ ¸å¿ƒä¿®æ­£ï¼šæ— è®ºæ˜¯æ¯’è¯è¿˜æ˜¯å®‰å…¨è¯ï¼Œå¾…é€‰æ—¶çš„å¤–è§‚ä¿æŒä¸€è‡´ ***
                    contentClass = 'bg-gray-700 border-2 border-indigo-400';
                    baseClass += ' hover:bg-indigo-600/30';
                }
            } else if (gameState === GAME_STATE.GAME_OVER) {
                // æ¸¸æˆç»“æŸçŠ¶æ€ï¼šä¸å¯ç‚¹å‡»
                dataAction = 'onclick=""';
                baseClass = 'word-card rounded-xl shadow-lg cursor-default';
                if (isRevealedPoison) {
                    contentClass = 'bg-red-900 border-4 border-red-500';
                } else if (isPoison) { // æœªè¢«æ­ç¤ºçš„æ¯’è¯
                    contentClass = 'bg-red-800/80 border-4 border-red-400';
                } else {
                    contentClass = 'bg-gray-700/80 border-2 border-gray-600/50 opacity-80';
                }
            }

            // ç¡®å®šå¡ç‰‡å†…å®¹
            if (item.hex) { 
                visualContent = `<div class="w-8 h-8 rounded-full shadow-md mb-1 border-2 border-white/20" style="background-color: ${item.hex}"></div>`;
                if (item.hex === '#f3f4f6') { 
                    textClass = 'text-black-on-white';
                }
            } else if (item.emoji) {
                visualContent = `<div class="text-3xl">${item.emoji}</div>`;
            }

            const itemContent = `
                ${visualContent}
                <div class="text-xs sm:text-sm font-bold ${textClass} tracking-wide leading-tight">${item.en}</div>
                <div class="text-[10px] sm:text-xs text-gray-400 font-medium mt-0.5">${item.cn}</div>
            `;

            return `
                <div class="h-full">
                    <div class="${baseClass}" ${dataAction}>
                        <div class="h-full w-full flex flex-col items-center justify-center p-1 rounded-lg ${contentClass} text-center">
                            ${itemContent}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayerStatus() {
            const container = document.getElementById('player-status-container');
            
            const playersHtml = players.map(p => {
                const isCurrent = gameState === GAME_STATE.UNRAVELING && !p.isDead && p.id === players[currentUnravelerIndex].id;
                
                let statusClass = 'bg-gray-700 border border-gray-600';
                let statusText = `<span class="text-yellow-400 font-bold text-[10px] sm:text-xs">æ´»è·ƒ</span>`;
                let icon = '<i data-lucide="smile" class="w-3 h-3 sm:w-4 sm:h-4 text-gray-400"></i>';

                if (p.isDead) {
                    statusClass = 'bg-red-900 border-2 border-red-500 opacity-60';
                    statusText = `<span class="text-red-400 font-bold flex items-center text-[10px] sm:text-xs"><i data-lucide="skull" class="w-2 h-2 mr-0.5"></i> æ·˜æ±°</span>`;
                    icon = '<i data-lucide="ghost" class="w-3 h-3 sm:w-4 sm:h-4 text-red-400"></i>';
                } else if (p.isSafe) { 
                    statusClass = 'bg-green-900 border-2 border-green-500';
                    statusText = `<span class="text-green-400 font-bold flex items-center text-[10px] sm:text-xs"><i data-lucide="trophy" class="w-2 h-2 mr-0.5"></i> è·èƒœ</span>`;
                    icon = '<i data-lucide="crown" class="w-3 h-3 sm:w-4 sm:h-4 text-yellow-400"></i>';
                } else if (isCurrent) {
                    statusClass = 'bg-indigo-700 border-2 border-indigo-400 ring-2 ring-2 ring-indigo-300 animate-pulse';
                    statusText = `<span class="text-indigo-200 font-bold flex items-center text-[10px] sm:text-xs">è½®åˆ°ä½ äº†</span>`;
                }

                return `
                    <div class="p-1.5 sm:p-2 rounded-lg shadow-inner flex items-center space-x-1 sm:space-x-2 transition duration-300 ${statusClass}">
                        <div class="flex-shrink-0">${icon}</div>
                        <div class="flex-grow min-w-0">
                            <p class="font-semibold text-xs sm:text-sm text-white truncate">${p.name}</p>
                            ${statusText}
                        </div>
                    </div>
                `;
            }).join('');

            const contentHtml = players.length > 0 ? playersHtml : '<p class="text-gray-500 text-center py-4">è¯·åœ¨å·¦ä¾§é¢æ¿è®¾ç½®ç©å®¶ã€‚</p>';

            container.innerHTML = `
                <div class="bg-gray-800 top-panel-p rounded-2xl shadow-xl border border-gray-700 h-full flex flex-col">
                    <h3 class="text-base sm:text-lg font-bold text-white mb-1 flex items-center space-x-1 flex-shrink-0 border-b border-gray-700 pb-1">
                        <i data-lucide="users" class="w-4 h-4 text-teal-400"></i>
                        <span>ç©å®¶çŠ¶æ€</span>
                    </h3>
                    <div class="grid grid-cols-2 gap-2 flex-grow min-h-0 overflow-y-auto p-0.5">
                        ${contentHtml}
                    </div>
                </div>
            `;
            renderIcons();
        }

        function renderStatusPanel() {
            const container = document.getElementById('status-panel-container');
            let statusHeader = '';
            let contentBodyHtml = ''; 
            let buttonHtml = ''; 
            let bodyClass = 'p-0.5'; 
            let contentLayout = ''; 

            if (gameState === GAME_STATE.SETUP) {
                statusHeader = 'âš™ï¸ æ¸¸æˆè®¾ç½®';
                contentLayout = 'space-y-2'; 
                
                const themeOptions = Object.keys(ALL_THEMES).map(key => 
                    `<option value="${key}" ${currentThemeKey === key ? 'selected' : ''}>${ALL_THEMES[key].name}</option>`
                ).join('');

                const playerInputs = players.map(p => `
                    <div class="flex items-center space-x-1">
                        <span class="text-gray-400 w-12 text-xs">P ${p.id}</span>
                        <input
                            type="text"
                            value="${p.name}"
                            onchange="handlePlayerNameChange(${p.id}, this.value)"
                            class="flex-grow p-1 border border-gray-600 rounded-md bg-gray-700 text-white text-xs focus:border-indigo-500 outline-none"
                            placeholder="æ˜µç§°"
                        />
                    </div>
                `).join('');

                contentBodyHtml = `
                    <div class="space-y-1">
                        <label class="block text-xs font-medium text-gray-400">ä¸»é¢˜/äººæ•°</label>
                        <div class="flex space-x-2">
                            <select 
                                onchange="handleThemeChange(this.value)"
                                class="flex-grow p-1 border border-gray-600 rounded-md bg-gray-700 text-white text-xs focus:border-indigo-500 outline-none"
                            >
                                ${themeOptions}
                            </select>
                            <select
                                value="${playerCount}"
                                onchange="handlePlayerCountChange(Number(this.value))"
                                class="w-16 p-1 border border-gray-600 rounded-md bg-gray-700 text-white text-xs focus:border-indigo-500 outline-none"
                            >
                                ${[2, 3, 4].map(num => `<option value="${num}" ${playerCount === num ? 'selected' : ''}>${num} äºº</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="bg-gray-700/50 p-2 rounded-lg border border-gray-700">
                        <h3 class="text-xs font-bold text-gray-300 mb-1">ç©å®¶æ˜µç§°</h3>
                        <div class="grid grid-cols-2 gap-1">
                            ${playerInputs}
                        </div>
                    </div>
                `;
                
                buttonHtml = `
                    <button
                        onclick="startGame()"
                        class="w-full py-1.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-lg hover:from-indigo-500 hover:to-purple-500 transition shadow-lg transform active:scale-95 flex items-center justify-center space-x-1 text-sm flex-shrink-0"
                    >
                        <span>å¼€å§‹æ¸¸æˆ</span>
                        <i data-lucide="play" class="w-4 h-4"></i>
                    </button>
                `;
            } else if (gameState === GAME_STATE.POTION_SELECTION) {
                statusHeader = 'ğŸ¤« ç§˜å¯†ä¸‹æ¯’';
                contentLayout = 'flex flex-col justify-center h-full'; 
                bodyClass = ''; 

                contentBodyHtml = `
                    <div class="text-center">
                        <div class="text-xs text-gray-400 mb-1">è½®åˆ°</div>
                        <div class="text-xl sm:text-2xl font-extrabold text-yellow-300 mb-2">${players[currentPlayerIndex].name}</div>
                        
                        <div class="bg-gray-700/50 p-2 rounded-lg mb-4">
                            <p class="text-sm text-white mb-0.5">è¯·å…¶ä»–ç©å®¶ <span class="text-red-400 font-bold">é—­çœ¼</span>ï¼</p>
                            <p class="text-[10px] text-gray-300">ç‚¹å‡»å¡ç‰‡ï¼Œå¼¹çª—ç¡®è®¤è®¾ä¸ºæ¯’è¯ã€‚</p>
                            <p class="text-[10px] text-gray-300">(å¯é‡å¤é€‰æ‹©æ¯’è¯)</p>
                        </div>

                        <div class="flex justify-center items-center space-x-1 text-xs text-gray-500">
                            <span>è¿›åº¦:</span>
                            <span class="font-mono bg-gray-700 px-1 py-0.5 rounded text-white">${currentPlayerIndex} / ${playerCount}</span>
                        </div>
                    </div>
                `;
            } else if (gameState === GAME_STATE.REVEAL_WAIT) {
                statusHeader = 'âš ï¸ æŒ‘æˆ˜é¢„å¤‡';
                contentLayout = 'flex flex-col justify-center h-full'; 
                bodyClass = '';

                const poisonCount = Object.keys(selectedPotions).length;
                const safeCount = currentItems.length - poisonCount;
                contentBodyHtml = `
                    <div class="text-center">
                        <i data-lucide="eye" class="w-8 h-8 text-green-400 mx-auto mb-1"></i>
                        <h3 class="text-lg font-bold text-white">å…¨å‘˜ççœ¼ï¼</h3>
                        <p class="text-gray-300 text-sm mb-3">åœºä¸Šæœ‰ <span class="text-red-400 font-bold">${poisonCount}</span> ç§æ¯’è¯ï¼Œ<span class="text-yellow-300 font-bold">${safeCount}</span> ä¸ªå®‰å…¨å•è¯ã€‚</p>
                    </div>
                `;
                buttonHtml = `
                    <button
                        onclick="handleUnravelingStart()"
                        class="w-full py-1.5 bg-green-600 text-white font-bold rounded-lg hover:bg-green-500 transition shadow-lg text-sm flex-shrink-0"
                    >
                        å¼€å§‹æŒ‘æˆ˜
                    </button>
                `;
            } else if (gameState === GAME_STATE.UNRAVELING) {
                // æŒ‘æˆ˜é˜¶æ®µï¼šåªæ˜¾ç¤ºæ“ä½œæç¤º (å·²ç§»é™¤æ•°é‡æ˜¾ç¤º)
                statusHeader = 'ğŸ¤ å•è¯æŒ‘æˆ˜';
                contentLayout = 'flex flex-col justify-center h-full'; 
                bodyClass = '';

                contentBodyHtml = `
                    <div class="text-center">
                        <div class="text-xs text-gray-400 mb-0.5">è½®åˆ°</div>
                        <div class="text-xl sm:text-2xl font-extrabold text-blue-300 mb-4 animate-pulse">${players[currentUnravelerIndex].name}</div>
                        
                        <div class="bg-indigo-900/30 border border-indigo-500/30 p-3 rounded-lg">
                            <p class="text-white text-base font-bold">è¯·å¤§å£°æœ—è¯»å•è¯å¹¶ç‚¹å‡»ï¼</p>
                        </div>
                    </div>
                `;
            } else if (gameState === GAME_STATE.GAME_OVER) {
                statusHeader = 'ğŸ† æ¸¸æˆç»“æŸ';
                contentLayout = 'flex flex-col justify-center h-full'; 
                bodyClass = '';

                const winners = players.filter(p => p.isSafe);
                
                let resultHtml = winners.length > 0 ? `
                    <div class="mb-2">
                        <div class="text-4xl mb-1">ğŸ‰</div>
                        <div class="text-lg font-bold text-green-400">è·èƒœè€…</div>
                        <div class="text-xl text-white font-extrabold">${winners.map(p => p.name).join(' & ')}</div>
                    </div>
                ` : `
                    <div class="mb-2">
                        <div class="text-4xl mb-1">ğŸ’€</div>
                        <div class="text-lg font-bold text-red-400">å…¨å‘˜æ·˜æ±°</div>
                    </div>
                `;
                    
                contentBodyHtml = `
                    <div class="text-center">
                        ${resultHtml}
                    </div>
                `;
                buttonHtml = `
                    <button
                        onclick="handleReset()"
                        class="w-full py-1.5 bg-white text-indigo-900 font-bold rounded-lg hover:bg-gray-100 transition shadow-lg flex items-center justify-center space-x-1 text-sm mt-2 flex-shrink-0"
                    >
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>å†ç©ä¸€æ¬¡</span>
                    </button>
                `;
            }

            container.innerHTML = `
                <div class="bg-gray-800 top-panel-p rounded-2xl shadow-2xl border border-gray-700 h-full flex flex-col">
                    <h2 class="text-base sm:text-lg font-bold text-white flex items-center space-x-1 border-b border-gray-700 pb-1 mb-2 flex-shrink-0">
                        <span class="text-base">${statusHeader.split(' ')[0]}</span>
                        <span>${statusHeader.split(' ')[1]}</span>
                    </h2>
                    
                    <div class="flex-grow min-h-0 overflow-y-auto ${bodyClass}">
                        <div class="${contentLayout}">
                            ${contentBodyHtml}
                        </div>
                    </div>

                    <div class="flex-shrink-0">
                        ${buttonHtml}
                        <p class="text-xs text-center text-red-400 font-medium mt-1 h-3">${message}</p>
                    </div>
                </div>
            `;
            renderIcons();
        }

        function renderGrid() {
            const container = document.getElementById('potions-grid');
            const themeNameSpan = document.getElementById('current-theme-name');
            
            if (!container) return;
            
            themeNameSpan.textContent = ALL_THEMES[currentThemeKey].name.split(' ')[0]; 

            container.innerHTML = currentItems.map(renderItemCard).join('');

            renderIcons();
        }


        // --- æ ¸å¿ƒé€»è¾‘ ---

        function initializeGame() {
            players = generateDefaultPlayers(playerCount);
            currentItems = selectRandomItems(currentThemeKey); 
            
            renderStatusPanel();
            renderPlayerStatus();
            renderGrid();
        }

        window.handleThemeChange = (key) => {
            currentThemeKey = key;
            currentItems = selectRandomItems(currentThemeKey);
            renderGrid();
        };

        window.handlePlayerCountChange = (count) => {
            playerCount = count;
            players = generateDefaultPlayers(count);
            renderStatusPanel();
            renderPlayerStatus();
        };

        window.handlePlayerNameChange = (id, newName) => {
            players = players.map(p => p.id === id ? { ...p, name: newName } : p);
        };

        window.startGame = () => {
            if (players.some(p => !p.name.trim())) {
                 setMessageText('è¯·å¡«å†™æ‰€æœ‰ç©å®¶çš„æ˜µç§°ï¼');
                 return;
            }
            if (playerCount > CARD_POOL_SIZE) {
                setMessageText(`ç©å®¶äººæ•° (${playerCount}) ä¸èƒ½è¶…è¿‡å¡ç‰‡æ€»æ•° (${CARD_POOL_SIZE})ï¼`);
                return;
            }

            currentItems = selectRandomItems(currentThemeKey); 

            players = players.map(p => ({ ...p, isDead: false, isSafe: false })); 
            gameState = GAME_STATE.POTION_SELECTION;
            currentPlayerIndex = 0;
            currentUnravelerIndex = 0; 
            selectedPotions = {}; 
            itemToConfirmId = null; 
            safePotions = [];

            setMessageText(`è¯· ${players[0].name} é€‰æ‹©ä¸€ä¸ªå•è¯ä½œä¸ºæ¯’è¯ã€‚`);
            
            renderStatusPanel();
            renderPlayerStatus(); 
            renderGrid();
        };

        // *** ç§˜å¯†é€‰æ‹©ï¼šç‚¹å‡»å¡ç‰‡ï¼Œæ‰“å¼€æ¨¡æ€æ¡†ç¡®è®¤ ***
        window.handleItemSelection = (itemId) => {
            if (gameState !== GAME_STATE.POTION_SELECTION) return;
            showConfirmationModal(itemId);
        };

        function showConfirmationModal(itemId) {
            const item = currentItems.find(i => i.id === itemId);
            if (!item) return;

            itemToConfirmId = itemId;
            const currentName = players[currentPlayerIndex].name;

            const modalContent = document.getElementById('modal-content');
            
            let visualContent = '';
            let textClass = 'text-white';
            
            if (item.hex) { 
                visualContent = `<div class="w-8 h-8 rounded-full shadow-md mb-2 border-2 border-white/20 mx-auto" style="background-color: ${item.hex}"></div>`;
                if (item.hex === '#f3f4f6') { 
                    textClass = 'text-black-on-white';
                }
            } else if (item.emoji) {
                visualContent = `<div class="text-4xl mb-2">${item.emoji}</div>`;
            }

            modalContent.innerHTML = `
                <h3 class="text-xl font-bold text-yellow-300 mb-2 text-center">ğŸ¤« ç¡®è®¤ä¸‹æ¯’</h3>
                <p class="text-sm text-gray-300 mb-4 text-center">ç©å®¶ <span class="font-bold text-white">${currentName}</span> ç¡®å®šé€‰æ‹©ä»¥ä¸‹å•è¯ä½œä¸ºæ¯’è¯å—ï¼Ÿ</p>
                
                <div class="bg-gray-700 border-2 border-yellow-500 rounded-xl p-4 mb-4 flex flex-col items-center justify-center shadow-lg">
                    ${visualContent}
                    <div class="text-lg sm:text-xl font-bold ${textClass} tracking-wide text-center leading-tight">${item.en}</div>
                    <div class="text-sm text-gray-400 mt-1 font-medium">${item.cn}</div>
                </div>

                <div class="flex space-x-3">
                    <button
                        onclick="handleCancelSelection()"
                        class="flex-grow py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-500 transition shadow-md text-sm"
                    >
                        <i data-lucide="x" class="w-4 h-4 mr-1 inline-block"></i>
                        å–æ¶ˆ
                    </button>
                    <button
                        onclick="handleConfirmSelection()"
                        class="flex-grow py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-500 transition shadow-md text-sm"
                    >
                        <i data-lucide="skull" class="w-4 h-4 mr-1 inline-block"></i>
                        ç¡®è®¤ä¸ºæ¯’è¯
                    </button>
                </div>
            `;

            document.getElementById('confirmation-modal').classList.remove('hidden');
            document.getElementById('confirmation-modal').classList.add('flex');
            renderIcons();
            setMessageText(''); 
        }

        // *** ç§˜å¯†é€‰æ‹©ï¼šç¡®è®¤æ­¥éª¤ï¼Œå®Œæˆé€‰æ‹©å¹¶åˆ‡æ¢ç©å®¶ ***
        window.handleConfirmSelection = () => {
            if (!itemToConfirmId) return;

            const itemId = itemToConfirmId;
            const currentPlayer = players[currentPlayerIndex];
            
            if (!selectedPotions[itemId] || selectedPotions[itemId] === 'REVEALED') {
                selectedPotions[itemId] = [];
            }
            selectedPotions[itemId].push(currentPlayer.id);
            
            console.log(`[é€‰æ‹©æ¯’è¯] ${currentPlayer.name} é€‰æ‹©äº† ${getItemName(itemId)}`);
            
            
            const nextPlayerIndex = currentPlayerIndex + 1;

            if (nextPlayerIndex < players.length) {
                currentPlayerIndex = nextPlayerIndex;
                setMessageText(`å·²è®°å½•ã€‚è¯·é—­çœ¼ï¼Œæ¢ ${players[nextPlayerIndex].name} æ“ä½œã€‚`);
            } else {
                safePotions = currentItems.filter(i => !isItemPoison(i.id)).map(i => i.id);
                gameState = GAME_STATE.REVEAL_WAIT;
                currentUnravelerIndex = 0;
                setMessageText('æ‰€æœ‰æ¯’è¯å·²å°±ä½ï¼');
                console.log(`[é˜¶æ®µ] æ¯’è¯åŸ‹è—å®Œæ¯•ï¼ŒæŒ‘æˆ˜å¼€å§‹ã€‚`);
            }
            
            // å…³é—­å¼¹çª—å¹¶æ¸…ç©ºæš‚å­˜
            handleCancelSelection(); 

            renderStatusPanel();
        };

        window.handleCancelSelection = () => {
            itemToConfirmId = null;
            document.getElementById('confirmation-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.remove('flex');
            if (gameState === GAME_STATE.POTION_SELECTION) {
                 setMessageText(`è¯· ${players[currentPlayerIndex].name} é€‰æ‹©ä¸€ä¸ªå•è¯ä½œä¸ºæ¯’è¯ã€‚`);
            }
            renderGrid();
        };

        window.handleUnravelingStart = () => {
            gameState = GAME_STATE.UNRAVELING;
            currentUnravelerIndex = players.findIndex(p => !p.isDead);

            setMessageText(`è¯· ${players[currentUnravelerIndex].name} æœ—è¯»å¹¶é€‰æ‹©ä¸€ä¸ªå•è¯ã€‚`);
            renderStatusPanel();
            renderGrid();
            renderPlayerStatus();
        };

        function checkGameOverAndAdvance() {
            const unrevealedPoisonsCount = Object.keys(selectedPotions).filter(id => isItemPoison(id)).length;
            const remainingSafe = safePotions.length;
            let activePlayers = players.filter(p => !p.isDead);

            // 1. å…¨å‘˜æ·˜æ±°
            if (activePlayers.length === 0) {
                gameState = GAME_STATE.GAME_OVER;
                setMessageText('æ¸¸æˆç»“æŸï¼Œæ— äººå¹¸å­˜ã€‚');
                return true;
            }

            // 2. ä»…å‰©ä¸€äººæ—¶ï¼Œæ­¤äººèƒœåˆ©
            if (activePlayers.length === 1) {
                gameState = GAME_STATE.GAME_OVER;
                const winner = activePlayers[0];
                players = players.map(p => ({ ...p, isSafe: p.id === winner.id }));
                setMessageText(`${winner.name} è·èƒœï¼`);
                return true;
            }

            // 3. å¡æ± æ¸…ç©º (æ‰€æœ‰å¹¸å­˜è€…è·èƒœ)
            if (remainingSafe === 0 && unrevealedPoisonsCount === 0) {
                gameState = GAME_STATE.GAME_OVER;
                players = players.map(p => ({ ...p, isSafe: !p.isDead })); 
                setMessageText('æ­å–œï¼æ‰€æœ‰å•è¯æŒ‘æˆ˜å®Œæˆï¼');
                return true;
            }

            let nextIndex = currentUnravelerIndex;
            let attempts = 0;
            do {
                nextIndex = (nextIndex + 1) % players.length;
                attempts++;
            } while (players[nextIndex].isDead && attempts <= players.length);

            if (attempts <= players.length) {
                currentUnravelerIndex = nextIndex;
                setMessageText(`è½®åˆ° ${players[currentUnravelerIndex].name}ã€‚`);
                return false;
            }
            return true; 
        }

        window.handleUnravelingChoice = (itemId) => {
            if (gameState !== GAME_STATE.UNRAVELING) return;

            const player = players[currentUnravelerIndex];
            const itemName = getItemName(itemId);

            if (isItemPoison(itemId)) {
                // é€‰ä¸­æ¯’è¯
                const killerIds = selectedPotions[itemId]; 
                const killerNames = killerIds.map(id => players.find(p => p.id === id)?.name || 'æœªçŸ¥').join('ã€');
                
                players = players.map(p => p.id === player.id ? { ...p, isDead: true } : p);
                selectedPotions[itemId] = 'REVEALED'; // æ ‡è®°ä¸ºå·²æ­ç¤º
                
                console.log(`ğŸ’€ ${player.name} é€‰ä¸­äº† ${itemName} (æ¯’è¯æ¥è‡ª: ${killerNames})ï¼æ·˜æ±°ï¼`);
            } else if (safePotions.includes(itemId)) {
                // é€‰ä¸­å®‰å…¨è¯
                safePotions = safePotions.filter(id => id !== itemId);
                console.log(`âœ¨ ${player.name} æˆåŠŸæœ—è¯»: ${itemName}`);
            } else {
                 return;
            }

            checkGameOverAndAdvance();
            
            renderPlayerStatus();
            renderGrid();
            renderStatusPanel();
        };

        window.handleReset = () => {
            gameState = GAME_STATE.SETUP;
            currentPlayerIndex = 0;
            currentUnravelerIndex = 0;
            selectedPotions = {};
            itemToConfirmId = null;
            safePotions = [];
            message = '';
            
            players = players.map(p => ({ ...p, isDead: false, isSafe: false })); 

            currentItems = selectRandomItems(currentThemeKey);
            
            renderStatusPanel();
            renderPlayerStatus();
            renderGrid();
        };

        // å¯åŠ¨
        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>
